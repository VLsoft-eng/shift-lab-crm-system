# Упрощенная CRM система

***

## Описание проекта

Это тестовое задание **ШИФТ ЛАБ**, целью которого является разработка упрощенной CRM-системы для управления информацией о продавцах и их транзакциях. Система включает функции для создания, чтения, обновления и удаления данных о продавцах и транзакциях, а также возможности для аналитики данных.

***

## Сборка и запуск

1. Клонируйте проект:

2. Настройте параметры подключения к базе данных в файле `application.properties`:

   ```properties
   spring.application.name=task
   spring.datasource.url=jdbc:postgresql:<url_к_бд>
   spring.datasource.username=<ваш_логин>
   spring.datasource.password=<ваш_пароль>

   spring.datasource.driver-class-name=org.postgresql.Driver

   spring.jpa.hibernate.ddl-auto=update
   ```

   **Примечание:** Используется база данных **PostgreSQL** для основной работы и **H2 in-memory** для тестирования.

***

## API

### Контроллер продавцов (`SellerController`)

#### 1. Создание продавца
- **Путь:** `POST api/sellers/create`
- **Тело запроса:**
```json
{
  "name": "Имя продавца",
  "contactInfo": "Контактная информация"
}

```

#### 2. Редактирование имени продавца
- **Путь:** `PATCH api/sellers/{id}/edit/name`
- **Параметры:**
    - `id` (должен быть положительным)
- **Тело запроса:**
```json
{
  "name": "Новое имя продавца"
}
```

#### 3. Редактирование контактной информации продавца
- **Путь:** `PATCH api/sellers/{id}/edit/contact-info`
- **Параметры:**
    - `id` (должен быть положительным)
- **Тело запроса:**
```json
{
  "contactInfo": "Новая контактная информация"
}
```

#### 4. Удаление продавца
- **Путь:** `DELETE api/sellers/{id}/delete`
- **Параметры:**
    - `id` (должен быть положительным)
- **Описание:** Удаляет продавца из системы.

#### 5. Получение информации о продавце
- **Путь:** `GET api/sellers/{id}`
- **Параметры:**
    - `id` (должен быть положительным)
- **Ответ:**
```json
{
  "id": 1,
  "name": "Имя продавца",
  "contactInfo": "Контактная информация",
  "registrationDate": "2024-10-20T12:34:56"
}
```

#### 6. Получение всех продавцов
- **Путь:** `GET api/sellers/all`
- **Ответ:**
```json
{
  [
    {
      "id": 1,
      "name": "Имя продавца",
      "contactInfo": "Контактная информация",
      "registrationDate": "2024-10-20T12:34:56"
    }
  ]
}
```

### Контроллер транзакций (`TransactionController`)

#### 1. Создание транзакции
- **Путь:** `POST api/transactions/create`
- **Тело запроса:**
```json
{
  "sellerId": 1,
  "amount": 100,
  "paymentType": "CASH",
  "transactionDate": "2024-10-20T12:34:56"
}
```
- **Примечание:** Поле `paymentType` должно содержать одно из значений: `CASH`, `CARD` или `TRANSFER`. Если значение не соответствует этим требованиям, будет возвращена ошибка валидации.


#### 2. Получение информации о транзакции
- **Путь:** `GET api/transactions/{id}`
- **Параметры:**
    - `id` (должен быть положительным)
- **Ответ:**
```json
{
  "id": 1,
  "sellerId": 1,
  "amount": 100,
  "paymentType": "CASH",
  "transactionDate": "2024-10-20T12:34:56"
}
```

#### 3. Получение всех транзакций
- **Путь:** `GET api/transactions/all`
- **Ответ:**
```json
{
 [
    {
      "id": 1,
      "sellerId": 1,
      "amount": 100,
      "paymentType": "CASH",
      "transactionDate": "2024-10-20T12:34:56"
    }
  ]
}
```

### Контроллер аналитики (`AnalyticController`)

#### 1. Поиск лучшего продавца за период
- **Путь:** `GET api/analytic/best-seller`
- **Тело запроса:**
```json
{
  "start": "2024-01-01T00:00:00",
  "period": "MONTH"
}
```
- **Примечание:** Поле `period` должно содержать одно из значений: `DAY`, `MONTH`, `QUARTER` или `YEAR`. Если значение не соответствует этим требованиям, будет возвращена ошибка валидации.
- **Ответ:**
```json
{
  "id": 1,
  "name": "Имя продавца",
  "contactInfo": "Контактная информация",
  "registrationDate": "2024-10-20T12:34:56"
}
```

#### 2. Поиск продавцов с общей суммой меньше указанной
- **Путь:** `GET api/analytic/sellers-sum-less`
- **Тело запроса:**
```json
{
  "start": "2024-01-01T00:00:00",
  "end": "2024-12-31T23:59:59",
  "threshold": 500
}
```
- **Ответ:**
```json
{
  [
    {
      "id": 1,
      "name": "Имя продавца",
      "contactInfo": "Контактная информация",
      "registrationDate": "2024-10-20T12:34:56"
    }
  ]
}
```

#### 3. Поиск лучшего периода продавца
- **Путь:** `GET /analytic/best-seller-period`
- **Тело запроса:**
```json
{
  "sellerId": 1,
  "daysInPeriod": 5
}
```
- **Ответ:**
```json
{
  "start": "2024-01-01T00:00:00",
  "end": "2024-12-31T23:59:59"
}
```

***

## Тестирование

Для проверки покрытия тестами используйте следующую команду:

```bash
./gradlew test
```

Чтобы просмотреть отчет о покрытии, откройте файл:

```bash
build/jacocoHtml/index.html
```

***

## Обработка ошибок

В системе реализована глобальная обработка ошибок, что позволяет централизованно управлять всеми исключениями и возвращать информативные ответы клиенту. При возникновении ошибки будет возвращён стандартный формат ответа с информацией об ошибке.

### Пример типовой ошибки

При возникновении ошибки валидации, система может вернуть следующий ответ:

```json
{
  "timestamp": "2024-10-20T12:34:56",
  "status": 400,
  "error": "Bad Request",
  "message": "message",
  "errorDetails": {
    "somefield1": "message",
    "somefield2": "message"
  },
  "path": "/api/some/path"
}
```
